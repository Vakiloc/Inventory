# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Release
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g. v0.1.1)'
        required: true
        default: 'v0.1.3'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  validate_node:
    name: Validate (Node/${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    defaults:
      run:
        working-directory: inventory-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: inventory-app/package-lock.json

      - run: npm ci
      - run: npm test
      - run: npm run build -w desktop
      - run: npm run build -w mobile

  validate_android:
    name: Validate (Android/Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        working-directory: inventory-app/android
        run: chmod +x gradlew

      - name: Unit tests
        working-directory: inventory-app/android
        run: ./gradlew :app:testDebugUnitTest

  build_desktop_win:
    name: Build desktop (Windows)
    needs: [validate_node]
    runs-on: windows-latest
    defaults:
      run:
        working-directory: inventory-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: inventory-app/package-lock.json

      - run: npm ci

      - name: Ensure 7zip binary exists
        shell: pwsh
        run: |
          $p = "node_modules/7zip-bin/win/x64/7za.exe"
          if (-not (Test-Path $p)) {
            Write-Host "7za.exe missing at $p. Attempting to add Defender exclusion and reinstall 7zip-bin..."
            try {
              Add-MpPreference -ExclusionPath "$env:GITHUB_WORKSPACE" | Out-Null
              Write-Host "Added Defender exclusion for $env:GITHUB_WORKSPACE"
            } catch {
              Write-Host "Add-MpPreference failed (continuing): $($_.Exception.Message)"
            }

            npm i --no-save 7zip-bin@5.2.0
          }

          if (-not (Test-Path $p)) {
            Write-Error "7za.exe still missing at $p"
            Get-ChildItem "node_modules/7zip-bin/win" -Recurse -Force -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
            exit 1
          }

      - name: Set RELEASE_VERSION from tag
        shell: bash
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          v="${TAG#v}"
          echo "RELEASE_VERSION=$v" >> "$GITHUB_ENV"

      - name: Package
        working-directory: inventory-app/desktop
        run: npm run dist:win

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win
          path: inventory-app/desktop/dist-electron/*.exe

  build_desktop_mac:
    name: Build desktop (macOS)
    needs: [validate_node]
    runs-on: macos-latest
    defaults:
      run:
        working-directory: inventory-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: inventory-app/package-lock.json

      - run: npm ci

      - name: Set RELEASE_VERSION from tag
        shell: bash
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          v="${TAG#v}"
          echo "RELEASE_VERSION=$v" >> "$GITHUB_ENV"

      - name: Package
        working-directory: inventory-app/desktop
        run: npm run dist:mac

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-mac
          path: |
            inventory-app/desktop/dist-electron/*.dmg
            inventory-app/desktop/dist-electron/*.zip

  build_desktop_linux:
    name: Build desktop (Linux)
    needs: [validate_node]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: inventory-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: inventory-app/package-lock.json

      - run: npm ci

      - name: Set RELEASE_VERSION from tag
        shell: bash
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          v="${TAG#v}"
          echo "RELEASE_VERSION=$v" >> "$GITHUB_ENV"

      - name: Package
        working-directory: inventory-app/desktop
        run: npm run dist:linux

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux
          path: |
            inventory-app/desktop/dist-electron/*.AppImage
            inventory-app/desktop/dist-electron/*.deb

  build_android_apk:
    name: Build Android (release APK)
    needs: [validate_android]
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v4

      - name: Set version from tag
        shell: bash
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION_NAME="${TAG#v}"
          echo "VERSION_NAME=$VERSION_NAME" >> "$GITHUB_ENV"
          echo "VERSION_CODE=$GITHUB_RUN_NUMBER" >> "$GITHUB_ENV"

      - name: Decode keystore (optional)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > inventory-app/android/release.jks
          echo "ANDROID_KEYSTORE_PATH=$GITHUB_WORKSPACE/inventory-app/android/release.jks" >> "$GITHUB_ENV"

      - name: Make gradlew executable
        working-directory: inventory-app/android
        run: chmod +x gradlew

      - name: Build APK
        working-directory: inventory-app/android
        env:
          VERSION_NAME: ${{ env.VERSION_NAME }}
          VERSION_CODE: ${{ env.VERSION_CODE }}
          ANDROID_KEYSTORE_PATH: ${{ env.ANDROID_KEYSTORE_PATH }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: ./gradlew :app:copyReleaseApk

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: inventory-app/android/app/artifacts/app-release.apk

  build_mobile_ios:
    name: Build mobile (iOS)
    needs: [validate_node]
    runs-on: macos-latest
    defaults:
      run:
        working-directory: inventory-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: inventory-app/package-lock.json

      - run: npm ci

      - name: Build mobile web assets
        run: npm run build -w mobile

      - name: Sync Capacitor iOS
        working-directory: inventory-app/mobile
        run: node scripts/cap-sync.mjs ios

      - name: Install CocoaPods dependencies
        working-directory: inventory-app/mobile/ios/App
        run: pod install

      - name: Build iOS archive
        working-directory: inventory-app/mobile/ios/App
        run: |
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Inventory.xcarchive \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive

      - name: Export unsigned IPA
        run: |
          mkdir -p $RUNNER_TEMP/ipa
          cd $RUNNER_TEMP/Inventory.xcarchive/Products/Applications
          mkdir Payload
          mv App.app Payload/
          zip -r $RUNNER_TEMP/ipa/Inventory-unsigned.ipa Payload

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-ios
          path: ${{ runner.temp }}/ipa/Inventory-unsigned.ipa

  publish:
    name: Publish GitHub Release
    needs: [build_desktop_win, build_desktop_mac, build_desktop_linux, build_android_apk, build_mobile_ios]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: desktop-win
          path: release-assets/desktop-win

      - uses: actions/download-artifact@v4
        with:
          name: desktop-mac
          path: release-assets/desktop-mac

      - uses: actions/download-artifact@v4
        with:
          name: desktop-linux
          path: release-assets/desktop-linux

      - uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: release-assets/android

      - uses: actions/download-artifact@v4
        with:
          name: mobile-ios
          path: release-assets/mobile-ios

      - name: Recreate release (wipe old assets)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const tag = context.eventName === 'workflow_dispatch'
              ? core.getInput('tag', { required: true })
              : context.ref.replace('refs/tags/', '')

            core.info(`Ensuring release for tag: ${tag}`)

            // The only reliable way to guarantee we don't accumulate hundreds of assets over multiple
            // reruns is to delete the existing release, which removes all its assets in one operation.
            try {
              const existing = await github.rest.repos.getReleaseByTag({ owner, repo, tag })
              await github.rest.repos.deleteRelease({ owner, repo, release_id: existing.data.id })
              core.info(`Deleted existing release id=${existing.data.id} for ${tag}`)
            } catch (e) {
              core.info(`No existing release to delete for ${tag} (continuing): ${e.status || e.message}`)
            }

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          generate_release_notes: true
          overwrite_files: false
          files: |
            release-assets/desktop-win/*.exe
            release-assets/desktop-mac/*.dmg
            release-assets/desktop-mac/*.zip
            release-assets/desktop-linux/*.AppImage
            release-assets/desktop-linux/*.deb
            release-assets/android/app-release.apk
            release-assets/mobile-ios/*.ipa
